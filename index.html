<!DOCTYPE html>
<html>
<head>
    <title>Elastic Drop: Outlier-Free Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 40px; background: #f4f7f6; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 180px; font-family: monospace; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
        button { background: #2c3e50; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; border-radius: 4px; font-size: 16px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        .cleaned { border-left: 5px solid #27ae60; background: #f0fff4; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .outlier-row { background-color: #ffe6e6; text-decoration: line-through; color: #c0392b; }
        code { background: #eee; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Bungee Analyzer</h1>
    <p>Paste data (headers: height mass chord distance):</p>
    <textarea id="dataInput">height mass chord distance
69.75 0.25 200.35 3.5
69.75 0.00 200.35 31.0
69.75 0.26 200.35 2.5
69.75 0.27 200.35 0.5
69.75 0.25 251.54 0.8
69.75 0.00 251.54 29.0
69.75 0.10 251.54 17.0
80.00 0.55 344.32 16.0
80.00 0.60 344.32 9.0
80.00 0.65 344.32 3.0
80.00 0.67 344.32 1.0
80.00 0.50 485.84 16.0
80.00 0.60 485.84 4.0
80.00 0.63 485.84 1.0</textarea>
    
    <button onclick="analyze()">Perform Dual Analysis</button>

    <div id="resultsView" style="display:none;">
        <div class="grid">
            <div class="card">
                <h3>1. Original (All Data)</h3>
                <p>R²: <b id="r2_orig"></b></p>
                <small>Equation:</small>
                <div id="eq_orig" style="font-size:0.8em; word-wrap: break-word; margin-top:5px; font-family:monospace;"></div>
            </div>

            <div class="card cleaned">
                <h3>2. Cleaned (No Outliers) </h3>
                <p>R²: <b id="r2_clean"></b></p>
                <small>Final Equation:</small>
                <div id="eq_clean" style="font-size:0.8em; word-wrap: break-word; margin-top:5px; font-family:monospace; font-weight:bold;"></div>
            </div>
        </div>

        <div id="mainPlot"></div>

        <h3>Data Review</h3>
        <p><small>Outliers (red) were removed from the <b>Cleaned</b> equation calculation.</small></p>
        <div id="tableOutput"></div>
    </div>
</div>

<script>
function solveRegression(h, m, c, y) {
    const X = h.map((_, i) => [1, h[i], m[i], c[i], h[i]**2, m[i]**2, c[i]**2]);
    const Xt = math.transpose(X);
    const XtX = math.multiply(Xt, X);
    const Xty = math.multiply(Xt, y);
    const coeffs = math.lusolve(XtX, Xty).map(val => val[0]);
    
    const yPred = X.map(row => math.multiply(row, coeffs));
    const residuals = y.map((val, i) => val - yPred[i]);
    const r2 = 1 - (math.sum(residuals.map(r => r**2)) / math.sum(y.map(val => (val - math.mean(y))**2)));
    
    let eqTerms = ["", "h", "m", "c", "h²", "m²", "c²"];
    let formula = `${coeffs[0].toFixed(3)}`;
    for(let i=1; i<7; i++) {
        formula += ` ${coeffs[i] >= 0 ? '+' : '-'} ${Math.abs(coeffs[i]).toFixed(3)}${eqTerms[i]}`;
    }
    
    return { coeffs, yPred, residuals, r2, formula };
}

function analyze() {
    const input = document.getElementById('dataInput').value.trim();
    const rows = input.split('\n').map(r => r.trim().split(/\s+/));
    rows.shift(); // Remove headers
    
    let h = [], m = [], c = [], y = [];
    rows.forEach(row => {
        h.push(parseFloat(row[0]));
        m.push(parseFloat(row[1]));
        c.push(parseFloat(row[2]));
        y.push(parseFloat(row[3]));
    });

    // STEP 1: Original Analysis
    const orig = solveRegression(h, m, c, y);
    const stdDev = math.std(orig.residuals);
    const isOutlier = orig.residuals.map(r => Math.abs(r) > (1.5 * stdDev));

    // STEP 2: Filter Data for Clean Analysis
    let h_c = [], m_c = [], c_c = [], y_c = [];
    isOutlier.forEach((out, i) => {
        if(!out) {
            h_c.push(h[i]); m_c.push(m[i]); c_c.push(c[i]); y_c.push(y[i]);
        }
    });

    const cleaned = solveRegression(h_c, m_c, c_c, y_c);

    // DISPLAY
    document.getElementById('resultsView').style.display = 'block';
    document.getElementById('r2_orig').innerText = orig.r2.toFixed(4);
    document.getElementById('eq_orig').innerText = "d = " + orig.formula;
    
    document.getElementById('r2_clean').innerText = cleaned.r2.toFixed(4);
    document.getElementById('eq_clean').innerText = "d = " + cleaned.formula;

    // TABLE
    let tableHtml = '<table><tr><th>H</th><th>M</th><th>C</th><th>Actual</th><th>Resid (Orig)</th><th>Status</th></tr>';
    rows.forEach((row, i) => {
        const status = isOutlier[i] ? "outlier" : "fitted";
        tableHtml += `<tr class="${isOutlier[i] ? 'outlier-row' : ''}">
            <td>${h[i]}</td><td>${m[i]}</td><td>${c[i]}</td><td>${y[i]}</td>
            <td>${orig.residuals[i].toFixed(2)}</td><td>${status}</td></tr>`;
    });
    document.getElementById('tableOutput').innerHTML = tableHtml + '</table>';

    // PLOT
    Plotly.newPlot('mainPlot', [
        { x: h, y: y, mode: 'markers', name: 'Raw Data', marker: {color: 'grey', opacity: 0.5} },
        { x: h_c, y: y_c, mode: 'markers', name: 'Clean Data', marker: {color: 'blue', size: 10} }
    ], { title: 'Cleaned Data (Blue) vs Outliers (Grey)', margin: {t:50} });
}
</script>
</body>
</html>
